{% extends "network/layout.html" %}

{% block body %}
<header>
    <div>
        <p id="followers_p">Followers: {{profile_owner.profile.followers.count}} Person</p>
        <p>
            {% if request.user == profile_owner %}
            You follow: {{ profile_owner.profile.following.count }} Person

            {% else %}
            {{ profile_owner }} follows: {{ profile_owner.profile.following.count }} Person
            {% endif %}
        </p>
    </div>
    {% if not request.user == profile_owner %}
    <form id="follow_form">
        {% csrf_token %}
        <button id="follow_btn" type="submit">
            {% if follow_status %}
            Unfolllow
            {% else %}
            Follow
            {% endif %}
        </button>
    </form>
    {% endif %}
</header>
{% include 'network/posts_list.html' %}
{% include 'network/pagination.html' %}
<script>
    let followForm = document.getElementById("follow_form");
    let followBtn = document.getElementById("follow_btn");
    let followers_p = document.getElementById("followers_p");
    const csrfToken = document.querySelector("[name='csrfmiddlewaretoken']").value;
    const profileOwnerUsername = "{{profile_owner.username}}"
    followForm.addEventListener("submit", function (e) {
        e.preventDefault();
        let formData = new FormData()
        formData.append("csrfmiddlewaretoken", csrfToken);
        formData.append("profile_page_owner_username", profileOwnerUsername);
        followBtn.disabled = true;
        fetch("{% url 'follow' profile_owner %}", {
            method: "POST",
            body: formData
        }).then(response => response.json()).then
            (data => {
                if (data.error) {
                    alert(data.error)
                } else if (data.redirect) {
                    window.location.href = data.redirect
                } else {
                    alert(data.message)
                    followBtn.classList.toggle("following", data.follow_status);
                    if (data.follow_status) {
                        followBtn.textContent = "Unfollow"
                    } else {
                        followBtn.textContent = "Follow"
                    }
                    followers_p.textContent = `Followers: ${data.followers_count} Person`
                }
            }).catch(error => alert(`error from catch: ${error}`))
        followBtn.disabled = false;
    })

</script>
{% endblock %}